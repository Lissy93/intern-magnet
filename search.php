<?php$pn = 2;$page_restrictions = "loggedin"; // (notloggedin || loggedin || any)// Start session and include files, if not already doneif(session_id() == '') { session_start(); }include_once $_SERVER['DOCUMENT_ROOT']."/php/Db.class.php";         // Database Classinclude_once $_SERVER['DOCUMENT_ROOT']."/php/UserActions.class.php";// User Actions Class$ua = new UserActions();$loggedIn = $ua->isLoggedIn();if($loggedIn){    $userObj = $ua->makeUserObject();    if(!$userObj){$loggedIn = false;}}$searchObj = new Search();$skillsObj = new Skills();$isSearching = false;$searchTerm = "";/* Simple Search */if(isset($_GET['s'])){    $searchTerm = $searchObj->formatSearchTerm($_GET['s']);    if($searchTerm!=""){        $isSearching = true;    }}/* Advanced Search */$advancedSearch = false;$fieldOfStudy = "";$city  = "";$university = "";$year = "";$skills = "";$type = "either";if(isset($_GET['f'])){    $fieldOfStudy = $searchObj->formatSearchTerm($_GET['f']);    if($fieldOfStudy!=""){$advancedSearch = true;}}if(isset($_GET['c'])){    $city = $searchObj->formatSearchTerm($_GET['c']);    if($city!=""){$advancedSearch = true;}}if(isset($_GET['u'])){    $university = $searchObj->formatSearchTerm($_GET['u']);    if($university!=""){$advancedSearch = true;}}if(isset($_GET['y'])){    $year = $searchObj->formatSearchTerm($_GET['y']);    if($year!=""){$advancedSearch = true;}}if(isset($_GET['k'])){    $skills = $searchObj->formatSearchTerm($_GET['k']);    if($skills!=""){$advancedSearch = true;}}if(isset($_GET['t'])){    $type = $_GET['t'];}if($advancedSearch == true){$isSearching = true;}if($isSearching){    if($advancedSearch){        $searchResults = $searchObj->advancedSearch($searchTerm, $fieldOfStudy, $city, $year, $skills, $type);        $numUsers = count($searchResults);        $resultsSummaryLine =  "Showing ".$numUsers." ". $fieldOfStudy." ".$ua->formatYearOfStudy($year);        if($type="students"){ $resultsSummaryLine.=" students";}        else if ($type="employers"){ $resultsSummaryLine.=" employers"; }        else{ $resultsSummaryLine.=" users";}        if($city!=""){$resultsSummaryLine.= " from $city"; }        if($university!=""){$resultsSummaryLine .= " who studied at $university"; }        if($skills!=""){$resultsSummaryLine .= " with $skills skills"; }    }    else{        $searchResults = $searchObj->getResltsFromTerm($searchTerm);        $resultsSummaryLine = "Showing ".count($searchResults)." results for ".$searchTerm;    }}if($loggedIn) {    /* Skills */    $skillsObj = new Skills();    $usersSkills = $skillsObj->getUsersSkills($userObj->getUserId());    $userHasSkills = false;    if (count($usersSkills) > 1) {        $userHasSkills = true;    } else if (count($usersSkills > 0)) {        if (count($usersSkills) == 1) {            if ($usersSkills[0] != "" && $usersSkills[0] != null && $usersSkills[0] != " ") {                $userHasSkills = true;            } else {                $userHasSkills = true;            }        }    }    /* Profile Completness */    $profileCompleteness =  $userObj->calculateProfileCompleteness();    $tips = $userObj->getProfileImprovementTips();    if($profileCompleteness<=20){ $c = "danger";        $m = "Urgent Attention Needed"; }    else if($profileCompleteness<=40){ $c = "warning";  $m = "Attention Needed"; }    else if($profileCompleteness<=70){ $c = "info";     $m = "Getting there";}    else if($profileCompleteness>70) { $c = "success";  $m = "Your profiles looking great!";}}?><!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <meta charset="utf-8">    <meta http-equiv="X-UA-Compatible" content="IE=edge">    <meta name="viewport" content="width=device-width, initial-scale=1">    <meta name="description" content="">    <meta name="author" content="Alicia Sykes">    <link rel="shortcut icon" href="img/favicon.ico">    <title>Search</title>    <!-- Bootstrap -->    <link href="css/bootstrap.min.css" rel="stylesheet">    <!-- Fonts -->    <link href='http://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>    <!-- Custom styles for template -->    <link href="css/login-styles.css" rel="stylesheet">    <link href="css/styles.css" rel="stylesheet">    <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.css" type="text/css" media="screen" />    <!-- Fancybox helpers -->    <link rel="stylesheet" href="/lib/fancybox/helpers/jquery.fancybox-buttons.css" type="text/css" media="screen" />    <link rel="stylesheet" href="/lib/fancybox/helpers/jquery.fancybox-thumbs.css" type="text/css" media="screen" />    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->    <!--[if lt IE 9]>    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>    <![endif]-->    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>    <script src="/lib/typeahead.jquery.min.js"></script></head><body>    <?php require($_SERVER['DOCUMENT_ROOT'] . "/html/navbar.php"); ?>    <div class=" main container main-no-fill">    <div class="row">        <?php        if($loggedIn){            if($profileCompleteness<81){?>                <div class="alert alert-<?php echo $c; ?>" role="alert" onclick="location.href='/settings.php#awsome-profile'" id="profile-completeness-notice">                    <?php echo $m." - profile is <b>".$profileCompleteness; ?>% complete</b>. <?php if(count($tips)>0){ ?>Click <a href="/settings.php#awsome-profile">here</a> to see <b>(<?php echo count($tips);?>)</b> tips for improvement<?php } ?>                </div>            <?php }        } ?>    </div>	<div class="row" <?php if(!$isSearching){ ?>style="margin-top: 60px;" <?php } ?>>            <div class="col-md-offset-1 col-sm-9 search-input-wrap">                <form action="/search.php" method="get">                    <h1>Search</h1>                        <input type="text" name="s" class="search-box" placeholder="Search by skills, location, university etc.."                               value="<?php if(isset($_GET['s'])){echo $_GET['s']; }?>" />                        <input type="submit" value="Search" class="search-button"/>                        <p class="toggle-advanced-search" id="toggle-as">Advanced Search</p>                        <br /><br /><br />                        <div class="advanced-search-wrap" style="display: none;">                            <h3>Advanced Search</h3>                            <div class="as-sub">                                <label class="as-label">Field of Study</label>                                <div id="ac-category" class="as-input-wrap">                                    <input class="typeahead as-input" type="text" placeholder="e.g. Business" name="f"                                           value="<?php if(isset($_GET['f'])){echo $_GET['f']; }?>"  />                                </div>                            </div>                            <div class="as-sub">                                <label class="as-label">City</label>                                <div id="ac-city" class="as-input-wrap">                                    <input class="typeahead as-input" type="text" placeholder="e.g. Oxford" name="c"                                           value="<?php if(isset($_GET['c'])){echo $_GET['c']; }?>"           >                                </div>                            </div>                            <div class="as-sub">                                <label class="as-label">Educational Institution</label>                                <div id="ac-school" class="as-input-wrap">                                    <input class="typeahead as-input" type="text" placeholder="e.g. UCL" name="u"                                           value="<?php if(isset($_GET['u'])){echo $_GET['u']; }?>"  />                                </div>                            </div>                            <div class="as-sub">                                <label class="as-label">Year of Study</label>                                <div id="ac-year" class="as-input-wrap">                                    <input class="typeahead as-input" type="text" placeholder="e.g 2" name="y"                                           value="<?php if(isset($_GET['y'])){echo $_GET['y']; }?>" >                                </div>                            </div>                            <div class="as-sub">                                <label class="as-label">Skills <span class="small-grey">(seperate with commas)</span></label>                                <div id="ac-skills" class="as-input-wrap">                                    <input class="typeahead as-input" type="text" placeholder="e.g. PHP, HTML5, CSS" name="k"                                           value="<?php if(isset($_GET['k'])){echo $_GET['k']; }?>" >                                </div>                            </div>                            <div class="as-sub">                                <label class="as-label">Student</label><input type="radio" name="t" value="student" />                                <label class="as-label">Employer</label><input type="radio" name="t" value="employer" />                                <label class="as-label">Either</label><input type="radio" name="t" value="either" checked/>                            </div>                            <input type="submit" value="Search" class="advanced-search-button"/>                        </div>                </form>            </div>        </div>	<?php if($isSearching){ ?>        <div class="row top-buffer">            <div class=" col-sm-2 col-md-offset-1 search-options-wrap">                <h4>Refine your Results</h4>                <form action="/search.php" method="get">                    <hr class="cat" />                    <h5>Field of Study</h5>                    <div id="ac-category" class="as-input-wrap">                        <input class="typeahead as-input as-small-input" type="text" placeholder="e.g. Business" name="f"                               value="<?php if(isset($_GET['f'])){echo $_GET['f']; }?>"  />                    </div>                    <hr class="cat" />                    <h5>Location</h5>                    <div id="ac-city" class="as-input-wrap">                        <input class="typeahead as-input as-small-input" type="text" placeholder="e.g. Oxford" name="c"                               value="<?php if(isset($_GET['c'])){echo $_GET['c']; }?>"           >                    </div>                    <hr class="cat" />                    <h5>Year of Study</h5>                    <div id="ac-year" class="as-input-wrap">                        <input class="typeahead as-input as-small-input" type="text" placeholder="e.g 2" name="y"                               value="<?php if(isset($_GET['y'])){echo $_GET['y']; }?>" >                    </div>                    <hr class="cat" />                    <h5>Skills</h5>                    <div id="ac-skills" class="as-input-wrap">                        <input class="typeahead as-input as-small-input" type="text" placeholder="e.g. PHP, HTML5, CSS" name="k"                               value="<?php if(isset($_GET['k'])){echo $_GET['k']; }?>" >                    </div>                    <hr class="cat" />                    <h5>Type of User</h5>                    <select name="t">                        <option vlaue="either">All</option>                        <option value="student">Student</option>                        <option value="employer">Employer</option>                    </select>                    <hr class="cat" />                    <input type="submit" value="Search" class="advanced-search-button-small"/>                    <br /><br />                </form>            </div>             <div class="col-sm-7 search-results-wrap">					<div class="search-results-wrap-inner">                        <p class="status-text"><?php echo $resultsSummaryLine; ?></p>                        <?php for($i=0; $i<count($searchResults); $i++){                            if($ua->userIdValid($searchResults[$i]->getUserId())){                            $skillArr = $skillsObj->getUsersSkills($searchResults[$i]->getUserId());                            ?>						<div class="search-block"  data-toggle="tooltip" data-placement="left" title="<?php echo $searchResults[$i]->getUserDescription();?>">                            <a class="block-link" href="/profile.php?userId=<?php echo $searchResults[$i]->getUserId();?>">                                <span class="pull-left"><img class="block-pic" src="<?php echo $searchResults[$i]->getGravatar(80); ?>" /></span>                                <span><strong><?php echo $searchResults[$i]->getFullName(); ?></strong> -                                    <i class="block-info-line"><?php echo $searchResults[$i]->getUserLine();  ?></i></span>                            </a>                                <br />                                <?php if(count($skillArr)>1){?><span><b>Skills: </b></span><?php } ?>                                <?php for($s = 0; $s<count($skillArr); $s++){ ?>                                    <a href="/search.php?skill=<?php echo $skillArr[$s];?>"><?php echo $skillArr[$s];?></a></span>                                <?php }   ?>						</div>						<?php }                        } ?>                        <br /><br />					</div>             </div>        </div>	<?php } ?></div><?php require($_SERVER['DOCUMENT_ROOT'] . "/html/footer.php"); ?><!-- Include all compiled plugins (below), or include individual files as needed --><script src="js/bootstrap.min.js"></script><script src="/js/notification-script.js"></script><script type="text/javascript" src="/lib/fancybox/jquery.fancybox.js"></script><script type="text/javascript" src="/lib/fancybox/helpers/jquery.fancybox-buttons.js"></script><script type="text/javascript" src="/lib/fancybox/helpers/jquery.fancybox-media.js"></script><script type="text/javascript" src="/lib/fancybox/helpers/jquery.fancybox-thumbs.js"></script><script>    $(document).ready(function() {        $("a.iframlink").fancybox({            'type':'iframe',            'width':500,            'centerOnScroll': true,            afterClose: function () {   parent.location.reload(true);   }        });    });    $('.search-block').tooltip({        'placement':'right auto'    });    $("#toggle-as").click(function(){       $(".advanced-search-wrap").slideToggle( "slow", function() {           // Animation complete.       });    });</script><script>    var substringMatcher = function(strs) {        return function findMatches(q, cb) {            var matches, substrRegex;            matches = [];            substrRegex = new RegExp(q, 'i');            $.each(strs, function(i, str) {                if (substrRegex.test(str)) {                    matches.push({ value: str });                }            });            cb(matches);        };    };    var years = ['1', '2', '3', '4', 'Graduated'];    var cities = <?php echo json_encode($searchObj->getAllCities()); ?>;    var schools = <?php echo json_encode($searchObj->getAllSchools()); ?>;    var categories = <?php echo json_encode($searchObj->getAllCategories()); ?>;    var skills = <?php echo json_encode($searchObj->getAllSkills()); ?>;    $('#ac-year .typeahead').typeahead({            hint: true, highlight: true, minLength: 1 },        {   name: 'years', displayKey: 'value',  source: substringMatcher(years)        });    $('#ac-city .typeahead').typeahead({            hint: true, highlight: true,  minLength: 1 },        {   name: 'cities',  displayKey: 'value',  source: substringMatcher(cities)        });    $('#ac-school .typeahead').typeahead({            hint: true, highlight: true,  minLength: 1 },        {   name: 'schools',  displayKey: 'value',  source: substringMatcher(schools)        });    $('#ac-category .typeahead').typeahead({            hint: true, highlight: true,  minLength: 1 },        {   name: 'categories',  displayKey: 'value',  source: substringMatcher(categories)        });    $('#ac-skills .typeahead').typeahead({            hint: true, highlight: true,  minLength: 1 },        {   name: 'skills',  displayKey: 'value',  source: substringMatcher(skills)        });</script></body></html>